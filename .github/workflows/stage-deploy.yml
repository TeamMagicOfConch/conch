name: Stage Deploy

on:
  push:
    branches:
      - stage-deploy
      - github-action # TEST

jobs:
  deploy:
    name: Deploy to Stage
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: ðŸ— Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ— Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ” Generate current fingerprint
        id: fingerprint
        run: |
          cd apps/conch
          npx @expo/fingerprint@latest > current-fingerprint.json
          echo "fingerprint_hash=$(cat current-fingerprint.json | jq -r '.hash')" >> $GITHUB_OUTPUT
        
      - name: ðŸ” Get previous fingerprint from git
        id: previous-fingerprint
        run: |
          cd apps/conch
          # ì´ì „ ì»¤ë°‹ì˜ fingerprint ê³„ì‚°
          git fetch origin stage-deploy --depth=2
          PREV_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$PREV_COMMIT" ]; then
            git checkout $PREV_COMMIT -- package.json ios android 2>/dev/null || true
            PREV_FINGERPRINT=$(npx @expo/fingerprint@latest 2>/dev/null | jq -r '.hash' || echo "none")
            git checkout HEAD -- package.json ios android 2>/dev/null || true
            echo "Previous fingerprint: $PREV_FINGERPRINT"
            echo "previous_hash=$PREV_FINGERPRINT" >> $GITHUB_OUTPUT
          else
            echo "previous_hash=none" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: ðŸ“Š Compare fingerprints
        id: compare
        run: |
          CURRENT="${{ steps.fingerprint.outputs.fingerprint_hash }}"
          PREVIOUS="${{ steps.previous-fingerprint.outputs.previous_hash }}"
          
          echo "Current fingerprint: $CURRENT"
          echo "Previous fingerprint: $PREVIOUS"
          
          # ì²« ë¹Œë“œì´ê±°ë‚˜ fingerprintê°€ ë‹¤ë¥´ë©´ ë¹Œë“œ í•„ìš”
          if [ "$PREVIOUS" = "none" ] || [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "needs_build=true" >> $GITHUB_OUTPUT
            echo "ðŸ”¨ Native changes detected or first build - will build"
          else
            echo "needs_build=false" >> $GITHUB_OUTPUT
            echo "âœ… No native changes detected - will use EAS Update"
          fi

      - name: ðŸš€ EAS Update (JS only changes)
        if: steps.compare.outputs.needs_build == 'false'
        run: |
          cd apps/conch
          eas update --channel stage --message "Auto update from stage-deploy [${{ github.sha }}]" --non-interactive

      - name: ðŸ”¨ EAS Build & Submit (Native changes detected)
        id: build
        if: steps.compare.outputs.needs_build == 'true'
        run: |
          cd apps/conch
          # ë¹Œë“œ ì™„ë£Œ í›„ ìžë™ìœ¼ë¡œ ì œì¶œ
          set -o pipefail
          eas build --platform all --profile preview --auto-submit --non-interactive 2>&1 | tee build-output.txt
          
          # ë¹Œë“œ URL ì¶”ì¶œ ë° ì €ìž¥
          IOS_URL=$(grep -o 'https://expo.dev/accounts/.*/projects/.*/builds/[^"]*' build-output.txt | grep ios | head -1 || echo "")
          ANDROID_URL=$(grep -o 'https://expo.dev/accounts/.*/projects/.*/builds/[^"]*' build-output.txt | grep android | head -1 || echo "")
          
          echo "ios_build_url=$IOS_URL" >> $GITHUB_OUTPUT
          echo "android_build_url=$ANDROID_URL" >> $GITHUB_OUTPUT

      - name: ðŸ“ Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`stage-deploy\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "**Fingerprint:** \`${{ steps.fingerprint.outputs.fingerprint_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.compare.outputs.needs_build }}" = "true" ]; then
            echo "### ðŸ”¨ Full Build + Submit" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** ${{ steps.build.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Platform:** iOS & Android" >> $GITHUB_STEP_SUMMARY
            echo "**Profile:** preview" >> $GITHUB_STEP_SUMMARY
            echo "**Destination:** TestFlight & Play Store Alpha" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "${{ steps.build.outputs.ios_build_url }}" ]; then
              echo "**iOS Build:** [${{ steps.build.outputs.ios_build_url }}](${{ steps.build.outputs.ios_build_url }})" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -n "${{ steps.build.outputs.android_build_url }}" ]; then
              echo "**Android Build:** [${{ steps.build.outputs.android_build_url }}](${{ steps.build.outputs.android_build_url }})" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ steps.build.outcome }}" = "failure" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Build or submission failed.** Check the logs above for details." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ðŸš€ EAS Update (OTA)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "**Channel:** stage" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** No native changes detected" >> $GITHUB_STEP_SUMMARY
          fi

