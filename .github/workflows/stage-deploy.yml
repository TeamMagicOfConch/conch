name: Stage Deploy

on:
  push:
    branches:
      - stage-deploy

jobs:
  # iOSì™€ Android ë³‘ë ¬ ì‹¤í–‰ì„ ìœ„í•œ Matrix Strategy
  deploy:
    name: Deploy to Stage - ${{ matrix.platform }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [ios, android]
      fail-fast: false  # í•œìª½ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ìª½ ê³„ì† ì§„í–‰
    
    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: ðŸ— Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ— Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ” Generate current fingerprint
        id: fingerprint
        run: |
          cd apps/conch
          
          if [ "${{ matrix.platform }}" = "ios" ]; then
            # iOS ê´€ë ¨ íŒŒì¼ë§Œ í•´ì‹±
            HASH=$(find ios package.json app.json -type f 2>/dev/null | sort | xargs cat | sha256sum | cut -d' ' -f1)
            echo "hash=$HASH" >> $GITHUB_OUTPUT
            echo "iOS fingerprint: $HASH"
          else
            # Android ê´€ë ¨ íŒŒì¼ë§Œ í•´ì‹±
            HASH=$(find android package.json app.json -type f 2>/dev/null | sort | xargs cat | sha256sum | cut -d' ' -f1)
            echo "hash=$HASH" >> $GITHUB_OUTPUT
            echo "Android fingerprint: $HASH"
          fi
        
      - name: ðŸ” Get previous fingerprint from git
        id: previous-fingerprint
        run: |
          cd apps/conch
          
          # Git historyì—ì„œ ì´ì „ ì»¤ë°‹ì˜ fingerprint ê³„ì‚°
          git fetch origin ${{ github.ref_name }} --depth=2
          PREV_COMMIT=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$PREV_COMMIT" ]; then
            # ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ì²´í¬ì•„ì›ƒ
            git checkout $PREV_COMMIT -- package.json ${{ matrix.platform }} app.json 2>/dev/null || true
            
            # Fingerprint ê³„ì‚°
            if [ "${{ matrix.platform }}" = "ios" ]; then
              PREV_HASH=$(find ios package.json app.json -type f 2>/dev/null | sort | xargs cat | sha256sum | cut -d' ' -f1 || echo "none")
            else
              PREV_HASH=$(find android package.json app.json -type f 2>/dev/null | sort | xargs cat | sha256sum | cut -d' ' -f1 || echo "none")
            fi
            
            # ì›ëž˜ëŒ€ë¡œ ë³µêµ¬
            git checkout HEAD -- package.json ${{ matrix.platform }} app.json 2>/dev/null || true
            
            echo "previous_hash=$PREV_HASH" >> $GITHUB_OUTPUT
            echo "âœ… Previous ${{ matrix.platform }} fingerprint: $PREV_HASH"
          else
            # ì²« ì»¤ë°‹ì´ë©´ ë¹Œë“œ í•„ìš”
            echo "previous_hash=none" >> $GITHUB_OUTPUT
            echo "ðŸ†• First commit - will build"
          fi
        continue-on-error: true

      - name: ðŸ“Š Compare fingerprints
        id: compare
        run: |
          CURRENT="${{ steps.fingerprint.outputs.hash }}"
          PREVIOUS="${{ steps.previous-fingerprint.outputs.previous_hash }}"
          
          echo "=== ${{ matrix.platform }} ==="
          echo "Current: $CURRENT"
          echo "Previous: $PREVIOUS"
          
          # ë¹Œë“œ í•„ìš” ì—¬ë¶€
          if [ "$PREVIOUS" = "none" ] || [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "needs_build=true" >> $GITHUB_OUTPUT
            echo "ðŸ”¨ ${{ matrix.platform }}: Native changes detected - will build"
          else
            echo "needs_build=false" >> $GITHUB_OUTPUT
            echo "âœ… ${{ matrix.platform }}: No native changes - will use EAS Update"
          fi

      - name: ðŸš€ EAS Update (JS only changes)
        if: steps.compare.outputs.needs_build == 'false'
        run: |
          cd apps/conch
          eas update \
            --platform ${{ matrix.platform }} \
            --channel stage \
            --environment preview \
            --message "Auto update ${{ matrix.platform }} from ${{ github.ref_name }} [${{ github.sha }}]" \
            --non-interactive

      - name: ðŸ”¨ EAS Build & Submit (Native changes detected)
        id: build
        if: steps.compare.outputs.needs_build == 'true'
        run: |
          cd apps/conch
          set -o pipefail
          
          # Fingerprintë¥¼ ë¹Œë“œ ë©”ì‹œì§€ì— í¬í•¨
          FINGERPRINT_HASH="${{ steps.fingerprint.outputs.hash }}"
          
          eas build \
            --platform ${{ matrix.platform }} \
            --profile preview \
            --environment preview \
            --auto-submit \
            --non-interactive \
            --message "Build from ${{ github.ref_name }} [${{ github.sha }}] - FP: ${FINGERPRINT_HASH:0:12}" \
            2>&1 | tee build-output-${{ matrix.platform }}.txt
          
          BUILD_URL=$(grep -o 'https://expo.dev/accounts/.*/projects/.*/builds/[^"]*' build-output-${{ matrix.platform }}.txt | head -1 || echo "")
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT

      - name: ðŸ“ Deployment Summary - ${{ matrix.platform }}
        if: always()
        run: |
          PLATFORM_EMOJI="${{ matrix.platform == 'ios' && 'ðŸ“±' || 'ðŸ¤–' }}"
          PLATFORM_NAME="${{ matrix.platform == 'ios' && 'iOS' || 'Android' }}"
          
          echo "## $PLATFORM_EMOJI $PLATFORM_NAME Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [\`${GITHUB_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "**Fingerprint:** \`${{ steps.fingerprint.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.compare.outputs.needs_build }}" = "true" ]; then
            echo "**Action:** ðŸ”¨ Build + Submit" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** ${{ steps.build.outcome == 'success' && 'âœ… Success' || (steps.build.outcome == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped') }}" >> $GITHUB_STEP_SUMMARY
            echo "**Profile:** preview" >> $GITHUB_STEP_SUMMARY
            echo "**Destination:** ${{ matrix.platform == 'ios' && 'TestFlight' || 'Play Store Alpha' }}" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "${{ steps.build.outputs.build_url }}" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Build URL:** [${{ steps.build.outputs.build_url }}](${{ steps.build.outputs.build_url }})" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ steps.build.outcome }}" = "failure" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Build or submission failed.** Check the logs for details." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Action:** ðŸš€ EAS Update (OTA)" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "**Channel:** stage" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** No native changes detected" >> $GITHUB_STEP_SUMMARY
          fi

